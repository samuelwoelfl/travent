<!DOCTYPE html>
<html lang="en" data-theme="theme-light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>travent</title>
  <link rel="shortcut icon" href="img/logo/icon.svg">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/cookies.css">

  <link rel="stylesheet" href="https://anandchowdhary.github.io/ionicons-3-cdn/icons.css" integrity="sha384-+iqgM+tGle5wS+uPwXzIjZS5v6VkqCUV7YQ/e/clzRHAxYbzpUJ+nldylmtBWCP0" crossorigin="anonymous">

  <!-- jQuery Stuff -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  <!-- iCal Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js" integrity="sha512-0izBc1upGYnrS1u1MX7QR+sjFIxZWxLVdNI7cUoHHCutDr5ENjuQRZuS+v+3NFNGfwHSrPoHzBzED0rV651tGw==" crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  <!-- Cookies Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js" integrity="sha512-Meww2sXqNHxI1+5Dyh/9KAtvI9RZSA4c1K2k5iL02oiPO/RH3Q30L3M1albtqMg50u4gRTYdV4EXOQqXEI336A==" crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
  <!-- fill css prefixes for browsers -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prefixfree/1.0.7/prefixfree.min.js"></script>
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD428BZelApsygZBJJlGJXvmCzBNldPTSY&libraries=places&callback=initMap&loading=async">
  </script>
  <!-- Google Identity Services (new OAuth library) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API Client Library -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <!-- Alternative Google API Client Library (fallback) -->
  <script src="https://apis.google.com/js/api.js?onload=gapiLoaded" async defer></script>
  <!-- Lootie Files -->
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <!-- Configuration -->
  <script src="config.js"></script>
  <!-- Custom Scripts -->
  <script src="js/form.js"></script>
  <script src="js/formSave.js"></script>
  <script src="js/cookies.js"></script>

</head>

<body>

  <div class="cookie_toggle_modal">
    <span class="icon">üç™</span>
    <div class="hidden">
      <span class="text">Cookie&nbsp;Settings:</span>
      <button id="toogle_cookies_button" class="primary" type="button" name="button">Accept Cookies</button>
    </div>
  </div>

  <div id="cookie_banner" class="start_banner" style="display:none">
    <div class="info">
      <span class="icon">üç™</span>
      <p>For optimal appearance and functionality, our website uses cookies.<br>Our cookies are purely functional and are not processed further.</p>
    </div>
    <button id="denie_cookies" class="secondary" type="button" name="button">Decline</button>
    <button id="accept_cookies" class="primary" type="button" name="button">Accept</button>
  </div>

  <div id="accepted_banner" class="start_banner" style="display:none" show-duration="4000">
    <div class="info">
      <span class="icon">üßô‚Äç‚ôÇÔ∏è</span>
      <p>Good choice! Our wizards are already at work on customizing the experience for you ‚ú®</p>
    </div>
    <div class="icons">
      <svg class="progress-ring banner_close_button" width="32" height="32">
        <circle class="progress-ring_circle" stroke-width="2" fill="transparent" r="10" cx="16" cy="16" />
        <line stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" x1="19" y1="13" x2="13" y2="19"></line>
        <line stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" x1="13" y1="13" x2="19" y2="19"></line>
      </svg>
    </div>
  </div>

  <div id="denied_banner" class="start_banner" style="display:none" show-duration="5000">
    <div class="info">
      <span class="icon">üëç</span>
      <p>Alright, you can change your preference at any time at the bottom right by hovering the cookie icon.</p>
    </div>
    <svg class="progress-ring banner_close_button" width="32" height="32">
      <circle class="progress-ring_circle" stroke-width="2" fill="transparent" r="10" cx="16" cy="16" />
      <line stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" x1="19" y1="13" x2="13" y2="19"></line>
      <line stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" x1="13" y1="13" x2="19" y2="19"></line>
    </svg>
  </div>

  <div id="welcome_banner" class="start_banner" style="display:none" show-duration="3500">
    <div class="info">
      <span class="icon">üëã</span>
      <p>Welcome back!</p>
    </div>
    <svg class="progress-ring banner_close_button" width="32" height="32">
      <circle class="progress-ring_circle" stroke-width="2" fill="transparent" r="10" cx="16" cy="16" />
      <line stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" x1="19" y1="13" x2="13" y2="19"></line>
      <line stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" x1="13" y1="13" x2="19" y2="19"></line>
    </svg>
  </div>


  <div class="wrapper">
    <div class="introduction">
      <img src="img/logo/logo.svg" alt="">
      <h1>Automatic public transport planner for upcoming calendar events</h1>
      <p id="text">Just connect your calendar events and travent will find the perfect connection to go there and back for every event and directly add it to your calendar to block the time.</p>
    </div>

    <form action="javascript:sendForm()">
      <h3>Calendar</h3>
      <label for="source_cal">Source Calendar URL</label>
      <input type="text" id="source_cal" name="source_cal" value="" placeholder="e.g. https://splan.hdm-stuttgart.de/splan/ical?lan=de&puid=22&type=config&lc=,F3,b,n,Nf,ov,Dy,xn&oex=false">
      <span class="description">A link that links to an iCal download - Google Calendar tutorial: Go to your Calendar Settings and click "share publicly", then go down to calendar integrations and copy the link from "public
        address in iCal format".</span>

      <label for="destination_cal">Destination Calendar for the new entries</label>
      <div class="container">
        <div class="left">
          <div class="google_button" id="authorize_button"><img class="icon" src="img/google-icon-logo-svg-vector.svg" width="18px" height="18px" alt=""><span class="text">Connect your Google Calendar</span></div>
          <div class="google_button" id="signout_button" style="display: none;"><img class="icon" src="img/google-icon-logo-svg-vector.svg" width="18px" height="18px" alt=""><span class="text">Sign Out of Account</span></div>
        </div>
        <span id="google_message" class="left"></span>
      </div>
      <div id="calendar_selection_container" style="display:none;">
        <label for="subcalendar">Select Destination Calendar:</label>
        <select id="subcalendar" name="subcalendar">
        </select>
      </div>
      <span class="description">The calendar in which the created events should be inserted.</span>

      <h3 id="location">Location</h3>
      <div class="input_group horizontal">
        <div class="input">
          <label for="start">Start-Location</label>
          <input type="text" id="start" name="start" value="" placeholder="Musterstreet 7a, Stuttgart">
          <span class="description">Where you start to go to your events - most likely your home</span>
        </div>

        <div class="input">
          <label for="end">Destination-Location (optional)</label>
          <input type="text" id="end" name="end" value="" optional="true" placeholder="Musterstreet 7a, Stuttgart">
          <span class="description">The adress of your events. Only needed if not already in the calendar event or to override the calendar event location</span>
        </div>
      </div>

      <h3 id="optional_settings">Optional Settings</h3>
      <div class="input_group horizontal">
        <div class="input">
          <label for="buffer_before">Buffer before event</label>
          <input type="text" id="buffer_before" name="buffer_before" value="" optional="true" placeholder="5">
          <span class="description">If you want to have some buffer for delay or so put it here - normal is 5min</span>
        </div>
        <div class="input">
          <label for="buffer_after">Buffer after event</label>
          <input type="text" id="buffer_after" name="buffer_after" value="" optional="true" placeholder="5">
          <span class="description">If it ends later, you have some talks or so - normal is 5min</span>
        </div>
      </div>

      <label for="preferred">Preferred transportation mode</label>
      <select id="preferred" name="preferred">
        <option value="">Get the best one for me</option>
        <option value="BUS">Bus</option>
        <option value="RAIL">All rails: train, tram, light rail, and subway</option>
        <option value="TRAM">Tram and light rail</option>
        <option value="TRAIN">Train</option>
        <option value="SUBWAY">Subway</option>
      </select>
      <span class="description">If you prefer to drive by a specific vehicle you can set this here</span>

      <button type="submit">
        <div class="loader">
          <div class="container">
            <div class="ball"></div>
            <div class="ball"></div>
            <div class="ball"></div>
            <div class="ball"></div>
            <!-- <div class="ball"></div> -->
          </div>
        </div>
        <div class="done">‚úÖ</div>
        <span class="text">Create Events</span>
      </button>

    </form>
    <p class="disclaimer">Disclaimer: It only works for one month in the
      future
      right now, because of Google Maps API limitations.</p>




    <span id="debug_errors"></span>

  </div>

  <script src="js/customSelect.js"></script>


  <script type="text/javascript">
    // Client ID and API key from configuration file
    var CLIENT_ID = config.GOOGLE_CLIENT_ID;
    var API_KEY = config.GOOGLE_API_KEY;

    // Authorization scopes required by the API
    var SCOPES = "https://www.googleapis.com/auth/calendar";

    var authorizeButton = document.getElementById('authorize_button');
    var signoutButton = document.getElementById('signout_button');
    var tokenClient;
    var gapiInited = false;
    var gisInited = false;
    var calendarsLoaded = false; // Flag to prevent multiple calendar loads

    /**
     * Callback after the Google Identity Services library loads.
     */
    function gisLoaded() {
      console.log('Google Identity Services loaded successfully');
      gisInited = true;
      maybeEnableButtons();
    }

    /**
     * Callback after the Google API client library loads.
     */
    function gapiLoaded() {
      console.log('Google API Client loaded successfully');
      
      // Initialize the Google API client
      gapi.load('client', function() {
        console.log('Google API client loaded, initializing...');
        gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]
        }).then(function() {
          console.log('Google API client initialized successfully');
          gapiInited = true;
          maybeEnableButtons();
        }).catch(function(error) {
          console.error('Failed to initialize Google API client:', error);
          changeSpanText('Error initializing Google API client: ' + error.message);
        });
      });
    }

    /**
     * Fallback if libraries fail to load.
     */
    function handleLibraryError() {
      changeSpanText("‚ö†Ô∏è Error: Google libraries failed to load. Please refresh the page.");
      authorizeButton.style.pointerEvents = 'none';
      authorizeButton.style.opacity = '0.5';
    }

    // Set a timeout to handle cases where libraries don't load
    setTimeout(function() {
      if (!gapiInited || !gisInited) {
        console.error('Google libraries failed to load after 10 seconds');
        changeSpanText("‚ö†Ô∏è Google libraries failed to load. This might be due to network issues or blocked requests. Please check your internet connection and try refreshing the page.");
        authorizeButton.style.pointerEvents = 'none';
        authorizeButton.style.opacity = '0.5';
        
        // Show additional troubleshooting info
        const troubleshootingInfo = `
          <br><br><strong>Troubleshooting:</strong>
          <br>‚Ä¢ Check if you can access https://accounts.google.com
          <br>‚Ä¢ Try disabling ad blockers or VPN
          <br>‚Ä¢ Check if your network blocks Google services
          <br>‚Ä¢ Try a different browser or incognito mode
        `;
        changeSpanText("‚ö†Ô∏è Google libraries failed to load. This might be due to network issues or blocked requests. Please check your internet connection and try refreshing the page." + troubleshootingInfo);
      }
    }, 10000); // 10 second timeout

    // Function to check if libraries are loaded and initialize them
    function checkAndInitializeLibraries() {
      // Check if Google Identity Services is loaded
      if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
        if (!gisInited) {
          console.log('Google Identity Services detected, initializing...');
          gisLoaded();
        }
      }

      // Check if Google API Client is loaded
      if (typeof gapi !== 'undefined' && gapi.client && gapi.client.init) {
        if (!gapiInited) {
          console.log('Google API Client detected, initializing...');
          gapiLoaded();
        }
      }

      // Additional check for gapi without client (sometimes it loads differently)
      if (typeof gapi !== 'undefined' && !gapiInited && !gapi.client) {
        console.log('Google API detected (without client), initializing...');
        gapiLoaded();
      }
    }

    // Poll for library availability with better error handling
    const libraryCheckInterval = setInterval(function() {
      checkAndInitializeLibraries();
      
      // Stop polling once both libraries are initialized
      if (gapiInited && gisInited) {
        clearInterval(libraryCheckInterval);
        console.log('Both Google libraries initialized successfully');
        changeSpanText('‚úÖ Google libraries loaded successfully');
      }
    }, 200); // Check every 200ms for better performance

    // Also try to load libraries manually if they fail
    setTimeout(function() {
      if (!gapiInited || !gisInited) {
        console.log('Attempting manual library initialization...');
        
        // Test if Google services are reachable
        testGoogleConnectivity();
        
        // Try to manually trigger library loading
        if (typeof gapi === 'undefined') {
          console.log('gapi not found, trying to load manually...');
          const script = document.createElement('script');
          script.src = 'https://apis.google.com/js/api.js';
          script.onload = function() {
            console.log('Google API Client loaded manually');
            gapiLoaded();
          };
          script.onerror = function() {
            console.error('Failed to load Google API Client manually');
          };
          document.head.appendChild(script);
        }
        
        if (typeof google === 'undefined' || !google.accounts) {
          console.log('Google Identity Services not found, trying to load manually...');
          const script = document.createElement('script');
          script.src = 'https://accounts.google.com/gsi/client';
          script.onload = function() {
            console.log('Google Identity Services loaded manually');
            gisLoaded();
          };
          script.onerror = function() {
            console.error('Failed to load Google Identity Services manually');
          };
          document.head.appendChild(script);
        }
      }
    }, 3000); // Wait 3 seconds before manual loading

    /**
     * Test if Google services are reachable
     */
    function testGoogleConnectivity() {
      console.log('Testing Google service connectivity...');
      
      // Test Google Identity Services
      fetch('https://accounts.google.com/gsi/client', {method: 'HEAD'})
        .then(response => {
          console.log('Google Identity Services reachable:', response.status);
        })
        .catch(error => {
          console.error('Google Identity Services not reachable:', error);
        });
      
      // Test Google API
      fetch('https://apis.google.com/js/api.js', {method: 'HEAD'})
        .then(response => {
          console.log('Google API reachable:', response.status);
        })
        .catch(error => {
          console.error('Google API not reachable:', error);
        });
    }

    /**
     * Enables user interaction after all libraries are loaded.
     */
    function maybeEnableButtons() {
      console.log('maybeEnableButtons called - gapiInited:', gapiInited, 'gisInited:', gisInited);
      
      if (gapiInited && gisInited) {
        console.log('Both libraries ready, initializing buttons...');
        
        // Additional check to ensure gapi.client is really ready
        if (typeof gapi === 'undefined' || !gapi.client || !gapi.client.init) {
          console.log('gapi.client not ready yet, waiting...');
          return;
        }
        
        // Initialize Google Identity Services
        gisInit();
        
        // Set up button event listeners
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
        
        // Check if user is already signed in
        checkSignInStatus();
        
        console.log('Buttons initialized successfully');
        changeSpanText('‚úÖ Google Calendar integration ready! Click "Connect your Google Calendar" to get started.');
      } else {
        console.log('Waiting for libraries to load...');
      }
    }



    /**
     * Initializes the Google Identity Services library.
     */
    function gisInit() {
      try {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // defined later
          ux_mode: 'popup', // Use popup mode to avoid COOP issues
          prompt: 'consent'
        });
        console.log('Google Identity Services initialized successfully');
      } catch (error) {
        console.error('Failed to initialize Google Identity Services:', error);
        changeSpanText('‚ö†Ô∏è Failed to initialize Google authentication. Please refresh the page.');
      }
    }

    /**
     * Checks if the user is already signed in.
     */
    function checkSignInStatus() {
      // Only check if Google API is ready
      if (!gapiInited || !gapi.client) {
        return;
      }

      const accessToken = localStorage.getItem('google_access_token');
      if (accessToken) {
        // User has a token, try to use it
        try {
          gapi.client.setToken({access_token: accessToken});
          updateSigninStatus(true);
          listCalends();
        } catch (error) {
          // If setting token fails, clear it and show sign-in state
          localStorage.removeItem('google_access_token');
          updateSigninStatus(false);
        }
      } else {
        updateSigninStatus(false);
      }
    }

    /**
     * Handles the sign-in flow.
     */
    function handleAuthClick() {
      // Check if Google API is ready
      if (!gapiInited || !gapi.client) {
        changeSpanText('‚ö†Ô∏è Google API is not ready yet. Please wait a moment and try again.');
        return;
      }

      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          changeSpanText('Error: ' + resp.error);
          return;
        }
        
        // Store the access token
        localStorage.setItem('google_access_token', resp.access_token);
        
        // Set the token for gapi client
        gapi.client.setToken({access_token: resp.access_token});
        
        // Update UI
        updateSigninStatus(true);
        
        // List calendars
        listCalends();
      };

      // Check if we already have a token
      try {
        const existingToken = gapi.client.getToken();
        if (existingToken === null) {
          // Prompt the user to select a Google Account and ask for consent
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          // Skip display of account chooser and consent dialog for an existing session
          tokenClient.requestAccessToken({prompt: ''});
        }
      } catch (error) {
        // If getToken fails, just request a new token
        tokenClient.requestAccessToken({prompt: 'consent'});
      }
    }

    /**
     * Handles the sign-out flow.
     */
    function handleSignoutClick() {
      // Check if Google API is ready
      if (!gapiInited || !gapi.client) {
        changeSpanText('‚ö†Ô∏è Google API is not ready yet. Please wait a moment and try again.');
        return;
      }

      try {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          localStorage.removeItem('google_access_token');
          updateSigninStatus(false);
        }
      } catch (error) {
        // If getToken fails, just clear local storage and update UI
        localStorage.removeItem('google_access_token');
        updateSigninStatus(false);
        changeSpanText('Signed out successfully');
      }
    }

    /**
     * Updates the UI based on sign-in status.
     */
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'flex';
        changeSpanText("üéâ You have been logged in successfully!");
      } else {
        authorizeButton.style.display = 'flex';
        signoutButton.style.display = 'none';
        changeSpanText("");
        
        // Clear and hide the calendar selection container
        $("#subcalendar").empty();
        $("#calendar_selection_container").hide();
        
        // Remove custom select styling if it exists
        try {
          $("#subcalendar").unwrap("div.select");
          $(".subcalendar").remove();
        } catch (error) {
          console.log('No existing custom select to remove');
        }
        

      }
    }

    /**
     * Lists the user's calendars.
     */
    function listCalends() {
      console.log('Loading calendars...');
      

      
      // Check if we have a valid token
      const accessToken = localStorage.getItem('google_access_token');
      if (!accessToken) {
        changeSpanText('‚ö†Ô∏è No access token available. Please sign in again.');
        return;
      }

      // Ensure the token is set for the API client
      try {
        gapi.client.setToken({access_token: accessToken});
      } catch (error) {
        console.error('Failed to set token:', error);
        changeSpanText('‚ö†Ô∏è Failed to authenticate with Google API. Please sign in again.');
        return;
      }

      gapi.client.calendar.calendarList.list({
        "minAccessRole": "writer",
        "showHidden": true
      }).then(function(response) {
        console.log('Calendars loaded successfully:', response);
        
        if (!response.result || !response.result.items) {
          changeSpanText('‚ö†Ô∏è No calendars found or insufficient permissions.');
          return;
        }

        var calendars = response.result.items;
        console.log('Found calendars:', calendars.length);
        
        // Clear existing options and remove any existing custom select styling
        $("#subcalendar").empty();
        try {
          $("#subcalendar").unwrap("div.select");
          $(".subcalendar").remove();
        } catch (error) {
          console.log('No existing custom select to remove');
        }
        
        // Add calendars to dropdown
        for (let index = 0; index < calendars.length; index++) {
          var calendar = calendars[index];
          var name = calendar.summary || 'Unnamed Calendar';
          var color = calendar.backgroundColor || '#4285f4';
          var id = calendar.id;
          
          console.log('Adding calendar:', name, id);
          
          $('#subcalendar').append(`<option value="${id}" data-color="${color}">${name}</option>`);
        }
        
        // Show the calendar selection container
        $("#calendar_selection_container").show();
        
        // Apply custom select styling
        setTimeout(function() {
          if (typeof createCustomSelect === 'function') {
            $('#subcalendar').each(createCustomSelect);
          } else {
            console.log('createCustomSelect function not available');
          }
        }, 100);
        
        changeSpanText(`‚úÖ Successfully loaded ${calendars.length} calendar(s). Please select one from the dropdown above.`);
        
        // Add a refresh button for calendars
        if (!$('#refresh_calendars').length) {
          $('#google_message').after('<button id="refresh_calendars" class="secondary" style="margin-top: 10px;">üîÑ Refresh Calendars</button>');
          $('#refresh_calendars').on('click', function() {
            listCalends();
          });
        }
        
      }).catch(function(error) {
        console.error('Error loading calendars:', error);
        
        if (error.status === 401) {
          changeSpanText('‚ö†Ô∏è Authentication failed. Please sign in again.');
          // Clear invalid token
          localStorage.removeItem('google_access_token');
          updateSigninStatus(false);
        } else if (error.status === 403) {
          changeSpanText('‚ö†Ô∏è Insufficient permissions to access calendars. Please check your Google Calendar settings.');
        } else {
          changeSpanText('‚ö†Ô∏è Error loading calendars: ' + (error.message || error.statusText || 'Unknown error'));
        }
      });
    }

    /**
     * Displays a message in the UI.
     */
    function changeSpanText(message) {
      var pre = $('span#google_message');
      var textContent = document.createTextNode(message + '\n');
      pre.html(textContent);
    }

    // Initialize when the page loads
    window.addEventListener('load', function() {
      // Ensure calendar selection is hidden initially
      $("#calendar_selection_container").hide();
    });

  </script>





</body>

</html>